<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>ç­¾åæˆæƒè´­ä¹° NFT</title>
</head>

<body>
	<h2>ğŸ· NFT æˆæƒç­¾åå·¥å…·</h2>

	<label>ç”¨æˆ·åœ°å€ï¼š</label><br />
	<input id="user" style="width: 400px;" value="0x321C4FF77f9069B520833fE938061468C9205D5E"><br /><br />

	<label>å•†å“ URIï¼š</label><br />
	<input id="uri" style="width: 400px;" value="http://127.0.0.1:8888/json/0.json"><br /><br />

	<label>ä»·æ ¼ï¼ˆç§¯åˆ†æ•°é‡ï¼‰ï¼š</label><br />
	<input id="cost" style="width: 100px;" value="10"><br /><br />

	<label>æˆªæ­¢æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰ï¼š</label><br />
	<input id="deadline" style="width: 200px;" value=""><br /><br />

	<label>Nonceï¼š</label><br />
	<input id="nonce" style="width: 100px;"><br /><br />

	<label>åˆçº¦åœ°å€ï¼ˆWinePlatformï¼‰ï¼š</label><br />
	<input id="wallet" style="width: 400px;" value="0x5e2c897C28BF96f804465643Aa7FC8EAe35a54D3"><br /><br />

	<button onclick="signAndSend()">ğŸ“¤ å‘é€</button>

	<h3>ç­¾åç»“æœï¼š</h3>
	<textarea id="output" style="width: 100%; height: 100px;"></textarea>

	<script src="ethers.umd.min.js"></script>
	<script>
		async function signAndSend() {
			if (!window.ethereum) {
				alert("è¯·å…ˆå®‰è£… MetaMask");
				return;
			}
			const provider = new ethers.BrowserProvider(window.ethereum);
			const signer = await provider.getSigner();

			const wallet = document.getElementById("wallet").value; // âœ… åˆçº¦åœ°å€å­—ç¬¦ä¸²
			const user = document.getElementById("user").value;
			const uri = document.getElementById("uri").value;
			const cost = parseInt(document.getElementById("cost").value);
			const deadline = parseInt(document.getElementById("deadline").value);

			const abi = [
				"function userNonce(address) view returns (uint256)",
				"function pointBalanceOf(address) view returns (uint256)"
			];

			const contract = new ethers.Contract(wallet, abi, provider);
			const currentNonce = await contract.userNonce(user);
			const balance = await contract.pointBalanceOf(user);
			document.getElementById("nonce").value = currentNonce;

			const nonce = parseInt(document.getElementById("nonce").value);

			if (balance < cost) {
				alert(`âŒ æ‚¨å½“å‰ç§¯åˆ†ä¸º ${balance}ï¼Œä¸è¶³ä»¥å…‘æ¢è¯¥å•†å“ï¼ˆéœ€è¦ ${cost}ï¼‰`);
				return;
			}

			if (!user || !uri || isNaN(cost) || isNaN(deadline) || isNaN(nonce) || !wallet) {
				alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
				return;
			}

			try {
				// âœ… 1. æ„é€  hash å¹¶ç­¾å
				const hash = ethers.solidityPackedKeccak256(
					["address", "string", "uint256", "uint256", "uint256", "address"],
					[user, uri, cost, deadline, nonce, wallet]
				);
				const bytes = ethers.getBytes(hash);
				const signature = await signer.signMessage(bytes);
				document.getElementById("output").value = signature;

				// âœ… 2. æ„é€  payload å¹¶å‘é€
				const payload = {
					user,
					uri,
					cost,
					deadline,
					nonce,
					signature
				};

				const response = await fetch("http://localhost:3000/redeem", {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify(payload)
				});

				const result = await response.json();

				if (!response.ok) {
					alert("âŒ åˆçº¦è°ƒç”¨å¤±è´¥: " + result.message);
					console.error(result);
				} else {
					alert("âœ… NFT é“¸é€ æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: " + result.txHash);
					console.log(result);
				}
			} catch (err) {
				console.error(err);
				alert("âŒ ç­¾åæˆ–å‘é€å¤±è´¥: " + err.message);
			}
		}


		// è‡ªåŠ¨å¡«å……å½“å‰æ—¶é—´ + 1 å°æ—¶ä¸ºé»˜è®¤ deadline
		window.onload = () => {
			const now = Math.floor(Date.now() / 1000);
			document.getElementById("deadline").value = now + 3600;
		};
	</script>
</body>

</html>
