<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ‰¹é‡ä¸Šä¼ å•†å“ JSON</title>
</head>
<body>
  <h2>æ‰¹é‡ä¸Šä¼ å•†å“åˆ—è¡¨ï¼ˆJSON æ–‡ä»¶ï¼‰</h2>

  <input type="file" id="jsonFile" accept=".json" />
  <button onclick="uploadJson()">å¼€å§‹ä¸Šä¼ </button>
  <pre id="log">è¯·ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ•°ç»„çš„ JSON æ–‡ä»¶</pre>

  <script>
    async function uploadJson() {
      const log = document.getElementById("log");
      const fileInput = document.getElementById("jsonFile");

      if (!fileInput.files.length) {
        log.textContent = "âŒ è¯·é€‰æ‹©ä¸€ä¸ª JSON æ–‡ä»¶";
        return;
      }

      const file = fileInput.files[0];
      const text = await file.text();

      let list;
      try {
        list = JSON.parse(text);
        if (!Array.isArray(list)) {
          throw new Error("æ–‡ä»¶å†…å®¹ä¸æ˜¯æ•°ç»„");
        }
      } catch (err) {
        log.textContent = "âŒ è§£æ JSON å¤±è´¥ï¼š" + err.message;
        return;
      }

      log.textContent = `âœ… è¯»å–æˆåŠŸï¼Œå‡†å¤‡ä¸Šä¼  ${list.length} æ¡æ•°æ®...\n`;

      let success = 0, failed = 0;

      for (const item of list) {
        const productId = item.productId;
        if (!productId) {
          log.textContent += `âŒ ç¼ºå°‘ productIdï¼Œè·³è¿‡\n`;
          failed++;
          continue;
        }

        try {
          const res = await fetch(`http://127.0.0.1:8787/write?productId=${productId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(item)
          });

          const text = await res.text();
          if (res.ok) {
            log.textContent += `âœ… ${productId} æˆåŠŸï¼š${text}\n`;
            success++;
          } else {
            log.textContent += `âŒ ${productId} å¤±è´¥ï¼š${text}\n`;
            failed++;
          }
        } catch (err) {
          log.textContent += `âŒ ${productId} å¼‚å¸¸ï¼š${err.message}\n`;
          failed++;
        }
      }

      log.textContent += `\nğŸ‰ æ€»è®¡æˆåŠŸ ${success} æ¡ï¼Œå¤±è´¥ ${failed} æ¡`;
    }
  </script>
</body>
</html>
